<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.huateng.xhcp.mapper.product.MerchInfoMapper">

	<!-- 查询 -->
	<select id="searchKeyWord" resultType="MerchInfo" parameterType="String">
		SELECT
			a.merch_id,
			a.NAME,
			a.`desc`,
			a.classify_id,
			b.pcls_id,
			price,
			in_stock,
			published_date,
			out_published,
			update_time,
			a.create_time,
			sm_recommend,
			free_shipping,
			unit,
			weight,
			standard,
			hits,
			CONCAT(c.path,c.`NAME`) merch_photo
		FROM
		tbl_merch_info a
		LEFT JOIN tbl_classify_info b ON a.classify_id = b.classify_id
		LEFT JOIN (
			SELECT
				MAX(GALLERY_ID) GALLERY_ID,
				MERCH_ID,
				MAX(`NAME`) AS NAME,
				MAX(PATH) AS PATH
			FROM
				tbl_merch_gallery
			GROUP BY MERCH_ID
		) c ON a.MERCH_ID = c.MERCH_ID
		WHERE 1=1 AND
		<foreach collection="keywords" item="key" separator=" OR " open="(" close=")">
			CONCAT(a.name ,',', a.`desc` ) LIKE CONCAT('%',#{key,jdbcType=VARCHAR},'%')
		</foreach>
	</select>

    <!-- 查询产品信息 -->
	<select id="queryMerchInfo" resultType="MerchInfo" parameterType="MerchInfo">
		SELECT
			a.merch_id,
			a.NAME,
			a.`desc`,
			a.classify_id,
			b.pcls_id,
			price,
			in_stock,
			published_date,
			out_published,
			update_time,
			a.create_time,
			sm_recommend,
			free_shipping,
			unit,
			weight,
			standard,
			hits,
			CONCAT(c.path,c.`NAME`) merch_photo
		FROM
		tbl_merch_info a
		LEFT JOIN tbl_classify_info b ON a.classify_id = b.classify_id
		LEFT JOIN (
			SELECT
				MAX(GALLERY_ID) GALLERY_ID,
				MERCH_ID,
				MAX(`NAME`) AS NAME,
				MAX(PATH) AS PATH
			FROM
				tbl_merch_gallery
			GROUP BY MERCH_ID
		) c ON a.MERCH_ID = c.MERCH_ID
		<where>
			<if test="merch_id != null and merch_id != ''">AND a.merch_id = #{merch_id,jdbcType=INTEGER}</if>
			<if test="name != null and name != ''">AND a.name = #{name,jdbcType=VARCHAR}</if>
			<if test="desc != null and desc != ''">AND a.`desc` = #{desc,jdbcType=VARCHAR}</if>
			<if test="classify_id != null and classify_id != ''">AND a.classify_id = #{classify_id,jdbcType=INTEGER}</if>
			<if test="price != null and price != ''">AND price = #{price,jdbcType=FLOAT}</if>
			<if test="in_stock != null and in_stock != ''">AND in_stock = #{in_stock,jdbcType=INTEGER}</if>
			<if test="published_date != null and published_date != ''">AND published_date = #{published_date,jdbcType=VARCHAR}</if>
			<if test="out_published != null and out_published != ''">AND out_published = #{out_published,jdbcType=VARCHAR}</if>
			<if test="update_time != null and update_time != ''">AND update_time = #{update_time,jdbcType=VARCHAR}</if>
			<if test="create_time != null and create_time != ''">AND a.create_time = #{create_time,jdbcType=VARCHAR}</if>
			<if test="sm_recommend != null and sm_recommend != ''">AND sm_recommend = #{sm_recommend,jdbcType=VARCHAR}</if>
			<if test="free_shipping != null and free_shipping != ''">AND free_shipping = #{free_shipping,jdbcType=VARCHAR}</if>
			<if test="unit != null and unit != ''">AND unit = #{unit,jdbcType=VARCHAR}</if>
			<if test="weight != null and weight != ''">AND weight = #{weight,jdbcType=FLOAT}</if>
			<if test="standard != null and standard != ''">AND standard = #{standard,jdbcType=VARCHAR}</if>
			<if test="hits != null and hits != ''">AND hits = #{hits,jdbcType=INTEGER}</if>
			
		</where>
		<if test="b_order_name != null  and b_order_name != ''"><![CDATA[ORDER BY ${b_order_name} ${b_order_asc}  ]]></if>
		<if test='b_order_name == null  and b_order_name == "" '><![CDATA[ORDER BY create_time DESC  ]]></if>
	</select>
	<!-- 查询产品信息 -->
	<select id="queryByPclsId" resultType="MerchInfo" parameterType="String">
		SELECT
			a.merch_id,
			a.NAME,
			a.`desc`,
			a.classify_id,
			b.pcls_id,
			price,
			in_stock,
			published_date,
			out_published,
			update_time,
			a.create_time,
			sm_recommend,
			free_shipping,
			unit,
			weight,
			standard,
			hits,
			CONCAT(c.path,c.`NAME`) merch_photo
		FROM
			tbl_merch_info a
		LEFT JOIN tbl_classify_info b ON a.classify_id = b.classify_id
		LEFT JOIN (
			SELECT
				MAX(GALLERY_ID) AS GALLERY_ID,
				MERCH_ID,
				MAX(`NAME`) AS NAME,
				MAX(PATH) AS PATH
			FROM
				tbl_merch_gallery
			GROUP BY
				MERCH_ID
		) c ON a.MERCH_ID = c.MERCH_ID
		WHERE
			a.classify_id IN (
				SELECT
					classify_id
				FROM
					tbl_classify_info
				WHERE
					pcls_id = #{classify_id,jdbcType=INTEGER}
			)
	</select>

	<!-- 查询销售最多的商品信息 -->
	<select id="queryHotMerch" resultType="MerchInfo">
		SELECT
			a.merch_id,
			b. NAME,
			b.price,
			a.merch_photo
		FROM
			(
				SELECT
					a.merch_id,
					(
						SELECT
							CONCAT(t.path, t. NAME)
						FROM
							tbl_merch_gallery t
						WHERE
							t.MERCH_ID = a.MERCH_ID
						LIMIT 1
					) merch_photo
				FROM
					tbl_merch_stat a
				GROUP BY
					a.merch_id
				ORDER BY
					sum(a.order_count) DESC
				LIMIT 3
			) a
		LEFT JOIN tbl_merch_info b ON a.merch_id = b.MERCH_ID
	</select>
	<!-- 查询浏览量最多的商品信息 -->
	<select id="queryHotHitsMerch" resultType="MerchInfo">
		SELECT
			a.merch_id,
			a.`NAME`,
			a.PRICE,
			(
				SELECT
					CONCAT(t.path, t. NAME)
				FROM
					tbl_merch_gallery t
				WHERE
					t.MERCH_ID = a.MERCH_ID
				LIMIT 1
			) merch_photo
		FROM
			tbl_merch_info a
		ORDER BY
			a.HITS DESC
		LIMIT 3
	</select>
	<!-- 新增产品 -->
	<insert id="addMerchInfo" parameterType="MerchInfo" useGeneratedKeys="true" keyProperty="merch_id">
		INSERT INTO tbl_merch_info (name,`desc`,classify_id,price,in_stock,published_date,out_published,update_time,create_time,sm_recommend,free_shipping,unit,weight,standard,hits)
		VALUES (#{name,jdbcType=VARCHAR},#{desc,jdbcType=VARCHAR},#{classify_id,jdbcType=INTEGER,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},#{price,jdbcType=FLOAT,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},#{in_stock,jdbcType=INTEGER,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},#{published_date,jdbcType=VARCHAR},#{out_published,jdbcType=VARCHAR},#{update_time,jdbcType=VARCHAR},DATE_FORMAT(now(),'%Y%m%d%H%i%s'),#{sm_recommend,jdbcType=VARCHAR},#{free_shipping,jdbcType=VARCHAR},#{unit,jdbcType=VARCHAR},#{weight,jdbcType=FLOAT,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},#{standard,jdbcType=VARCHAR},#{hits,jdbcType=INTEGER})
	</insert>
	
	<!-- 批量新增产品信息 -->
	<insert id="addBatchMerchInfo" parameterType="MerchInfo">
		INSERT INTO tbl_merch_info (merch_id,name,`desc`,classify_id,price,in_stock,published_date,out_published,update_time,create_time,sm_recommend,free_shipping,unit,weight,standard,hits)
		<foreach item="item" collection="list" separator="union all">
			SELECT #{item.merch_id,jdbcType=INTEGER},#{item.name,jdbcType=VARCHAR},#{item.desc,jdbcType=VARCHAR},#{item.classify_id,jdbcType=INTEGER,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},#{item.price,jdbcType=FLOAT},#{item.in_stock,jdbcType=INTEGER},#{item.published_date,jdbcType=VARCHAR},#{item.out_published,jdbcType=VARCHAR},#{item.update_time,jdbcType=VARCHAR},DATE_FORMAT(now(),'%Y%m%d%H%i%s'),#{item.sm_recommend,jdbcType=VARCHAR},#{item.free_shipping,jdbcType=VARCHAR},#{item.unit,jdbcType=VARCHAR},#{item.weight,jdbcType=FLOAT},#{item.standard,jdbcType=VARCHAR},#{item.hits,jdbcType=INTEGER}
			FROM dual
		</foreach>
	</insert>
	
	<!-- 更新产品信息 -->
	<update id="updateMerchInfo" parameterType="MerchInfo">
		UPDATE tbl_merch_info
		<set>
	      	<if test="merch_id != null">merch_id = #{merch_id,jdbcType=INTEGER},</if>
	      	<if test="name != null">name = #{name,jdbcType=VARCHAR},</if>
	      	<if test="desc != null">`desc` = #{desc,jdbcType=VARCHAR},</if>
	      	<if test="classify_id != null">classify_id = #{classify_id,jdbcType=INTEGER,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},</if>
	      	<if test="price != null">price = #{price,jdbcType=FLOAT,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},</if>
	      	<if test="in_stock != null">in_stock = #{in_stock,jdbcType=INTEGER,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},</if>
	      	<if test="published_date != null">published_date = #{published_date,jdbcType=VARCHAR},</if>
	      	<if test="out_published != null">out_published = #{out_published,jdbcType=VARCHAR},</if>
	      	<if test="update_time != null">update_time = DATE_FORMAT(now(),'%Y%m%d%H%i%s'),</if>
	      	<if test="sm_recommend != null">sm_recommend = #{sm_recommend,jdbcType=VARCHAR},</if>
	      	<if test="free_shipping != null">free_shipping = #{free_shipping,jdbcType=VARCHAR},</if>
	      	<if test="unit != null">unit = #{unit,jdbcType=VARCHAR},</if>
	      	<if test="weight != null">weight = #{weight,jdbcType=FLOAT,typeHandler=com.huateng.xhcp.handler.IntegerNullValueHandler},</if>
	      	<if test="standard != null">standard = #{standard,jdbcType=VARCHAR},</if>
	      	<if test="hits != null">hits = #{hits,jdbcType=INTEGER},</if>
	      	
		</set>
		WHERE merch_id = #{merch_id,jdbcType=VARCHAR}
	</update>

	<!-- 更新点击数 -->
	<update id="updateHits" parameterType="String">
		UPDATE tbl_merch_info SET hits = IFNULL(hits, 0) + 1 WHERE merch_id = #{merch_id,jdbcType=INTEGER}
	</update>
	
	<!-- 删除产品信息 -->
	<delete id="deleteMerchInfo" parameterType="MerchInfo">
		DELETE FROM tbl_merch_info WHERE merch_id = #{merch_id,jdbcType=INTEGER}
	</delete>
	
	<!-- 批量删除产品信息-->
	<delete id="deleteBatchMerchInfo" parameterType="MerchInfo">
		DELETE FROM tbl_merch_info WHERE merch_id IN
		<foreach collection="list" item="item" index="index" open="(" close=")" separator=",">
			#{item.merch_id,jdbcType=INTEGER}
		</foreach>
	</delete>
</mapper>
